<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flute Crafting Calculator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Georgia', 'Palatino', serif;
            background: linear-gradient(135deg, #f5e6d3 0%, #e8d5c4 100%);
            color: #3e2723;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(62, 39, 35, 0.1);
            overflow: hidden;
        }

        header {
            background: linear-gradient(135deg, #8b6f47 0%, #6d5738 100%);
            color: #fff;
            padding: 20px 30px;
            border-bottom: 4px solid #5d4a37;
            display: flex;
            align-items: center;
            gap: 30px;
        }

        header h1 {
            font-size: 2em;
            line-height: 1.2;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            margin: 0;
            flex-shrink: 0;
        }

        .tabs {
            display: flex;
            background: transparent;
            overflow-x: auto;
            flex: 1;
        }

        .tab-button {
            flex: 1;
            padding: 15px 20px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            margin: 0 5px;
            color: #fff;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Georgia', 'Palatino', serif;
        }

        .tab-button:last-child {
            margin-right: 0;
        }

        .tab-button:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.5);
        }

        .tab-button.active {
            background: rgba(255, 255, 255, 0.95);
            color: #3e2723;
            border-color: #fff;
        }

        .tab-content {
            display: none;
            padding: 30px;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .algorithm-explanation {
            background: #fff8f0;
            border-left: 4px solid #8b6f47;
            margin-bottom: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            overflow: hidden;
        }

        .algorithm-explanation-header {
            padding: 20px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            user-select: none;
        }

        .algorithm-explanation-header:hover {
            background: #fff4e6;
        }

        .algorithm-explanation-toggle {
            font-size: 1.5em;
            transition: transform 0.3s ease;
        }

        .algorithm-explanation-toggle.expanded {
            transform: rotate(180deg);
        }

        .algorithm-explanation-content {
            padding: 0 20px 20px 20px;
            display: none;
        }

        .algorithm-explanation-content.expanded {
            display: block;
        }

        .algorithm-inputs {
            background: #f5e6d3;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 15px;
            font-family: 'Courier New', monospace;
            font-size: 0.95em;
        }

        .algorithm-inputs strong {
            color: #6d5738;
        }

        .algorithm-explanation h2 {
            color: #6d5738;
            margin-bottom: 15px;
            font-size: 1.5em;
        }

        .algorithm-explanation h3 {
            color: #8b6f47;
            margin-top: 15px;
            margin-bottom: 10px;
            font-size: 1.2em;
        }

        .algorithm-explanation p,
        .algorithm-explanation ul {
            line-height: 1.8;
            color: #5d4a37;
        }

        .algorithm-explanation ul {
            margin-left: 20px;
            margin-top: 10px;
        }

        .algorithm-explanation li {
            margin-bottom: 8px;
        }

        .formula {
            background: #f5e6d3;
            padding: 10px 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            margin: 10px 0;
            display: inline-block;
            border: 1px solid #d4b896;
        }

        .input-section {
            background: white;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 25px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
        }

        .input-section h3 {
            color: #6d5738;
            margin-bottom: 20px;
            font-size: 1.3em;
            border-bottom: 2px solid #d4b896;
            padding-bottom: 10px;
        }

        .input-group {
            margin-bottom: 20px;
        }

        /* Responsive grid for input fields on larger screens */
        @media (min-width: 768px) {
            .input-section {
                max-width: 800px;
            }
            
            .input-grid {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 20px;
            }
            
            .input-grid .input-group {
                margin-bottom: 0;
            }
            
            .input-grid.full-width {
                grid-template-columns: 1fr;
            }
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #5d4a37;
            font-weight: bold;
            font-size: 1em;
        }

        input[type="number"],
        select {
            width: 100%;
            padding: 12px;
            border: 2px solid #d4b896;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s ease;
            background: #fffcf7;
            font-family: 'Georgia', 'Palatino', serif;
        }

        input[type="number"]:focus,
        select:focus {
            outline: none;
            border-color: #8b6f47;
            background: white;
        }

        .input-hint {
            font-size: 0.9em;
            color: #8b6f47;
            margin-top: 5px;
            font-style: italic;
        }

        .calculate-button {
            background: linear-gradient(135deg, #8b6f47 0%, #6d5738 100%);
            color: white;
            padding: 15px 40px;
            border: none;
            border-radius: 10px;
            font-size: 1.2em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(109, 87, 56, 0.3);
            font-family: 'Georgia', 'Palatino', serif;
        }

        .calculate-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(109, 87, 56, 0.4);
        }

        .calculate-button:active {
            transform: translateY(0);
        }

        .results-section {
            margin-top: 30px;
        }

        .results-section h3 {
            color: #6d5738;
            margin-bottom: 20px;
            font-size: 1.3em;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
        }

        th {
            background: linear-gradient(135deg, #8b6f47 0%, #6d5738 100%);
            color: white;
            padding: 15px;
            text-align: left;
            font-size: 1.1em;
        }

        td {
            padding: 15px;
            border-bottom: 1px solid #f0e6d8;
            color: #3e2723;
        }

        tr:hover {
            background: #fff8f0;
        }

        tr:last-child td {
            border-bottom: none;
        }

        .hidden {
            display: none;
        }

        .warning-indicator {
            display: inline-block;
            margin-left: 5px;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.85em;
            font-weight: bold;
        }

        .warning-comfortable {
            background: #d4edda;
            color: #155724;
        }

        .warning-difficult {
            background: #fff3cd;
            color: #856404;
        }

        .warning-limit {
            background: #f8d7da;
            color: #721c24;
        }

        /* Modal/Backdrop styles */
        .modal-backdrop {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.3s ease;
        }

        .modal-backdrop.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 90%;
            max-height: 90%;
            overflow: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            position: relative;
        }

        .modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: #8b6f47;
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 1.5em;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .modal-close:hover {
            background: #6d5738;
            transform: rotate(90deg);
        }

        .visualization-button {
            background: linear-gradient(135deg, #4a7c59 0%, #2d5a3a 100%);
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(74, 124, 89, 0.3);
            font-family: 'Georgia', 'Palatino', serif;
            margin-top: 20px;
        }

        .visualization-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(74, 124, 89, 0.4);
        }

        .flute-svg {
            width: 100%;
            max-height: 800px;
        }

        footer {
            text-align: center;
            padding: 20px;
            color: #8b6f47;
            font-size: 0.9em;
        }

        @media (max-width: 768px) {
            header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }

            header h1 {
                font-size: 1.5em;
            }

            .tabs {
                width: 100%;
            }

            .tab-button {
                font-size: 0.85em;
                padding: 12px 10px;
            }

            .tab-content {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üéµ Flute Crafting<br>Calculator</h1>
            <div class="tabs">
                <button class="tab-button active" onclick="switchTab('simple')">Xiao - Sanfen Sunyi</button>
                <button class="tab-button" onclick="switchTab('acoustical')">Acoustical Physics Method</button>
                <button class="tab-button" onclick="switchTab('benade')">Benade's Formula</button>
            </div>
        </header>

        <!-- Simple Ratio Method Tab (Xiao Flute - Sanfen Sunyi) -->
        <div id="simple" class="tab-content active">
            <div class="algorithm-explanation">
                <div class="algorithm-explanation-header" onclick="toggleAlgorithm('simple-algo')">
                    <h2>Xiao Flute - Sanfen Sunyi Method (‰∏âÂàÜÊçüÁõäÊ≥ï)</h2>
                    <span class="algorithm-explanation-toggle" id="simple-algo-toggle">‚ñº</span>
                </div>
                <div class="algorithm-explanation-content" id="simple-algo-content">
                    <div class="algorithm-inputs" id="simple-algo-inputs">
                        <strong>Current Inputs:</strong><br>
                        Base Frequency: <span id="simple-input-frequency">440</span> Hz<br>
                        Inner Diameter: <span id="simple-input-diameter">19</span> mm<br>
                        Temperature: <span id="simple-input-temp">20</span> ¬∞C<br>
                        Number of Holes: <span id="simple-input-holes">6</span>
                    </div>
                    <p>The Sanfen Sunyi (‰∏âÂàÜÊçüÁõäÊ≥ï) is an ancient Chinese mathematical method for calculating musical intervals, perfect for crafting Xiao flutes. This method creates beautiful pentatonic scales by alternating between adding and subtracting thirds.</p>
                    
                    <h3>How it Works:</h3>
                    <ul>
                        <li>Start with the base frequency of your bamboo (the fundamental note)</li>
                        <li><strong>San Fen Sun Yi (‰∏âÂàÜÊçü‰∏Ä):</strong> "Divide into three parts, lose one" - multiply frequency by 3/2 (perfect fifth up)</li>
                        <li><strong>San Fen Yi Yi (‰∏âÂàÜÁõä‰∏Ä):</strong> "Divide into three parts, gain one" - multiply frequency by 4/3 (perfect fourth up)</li>
                        <li>For each hole, you can choose the next interval to create your desired scale</li>
                        <li>Includes acoustic correction based on bore diameter and temperature</li>
                    </ul>

                    <h3>Calculation Details:</h3>
                    <p>The effective length for each note is calculated as:</p>
                    <ul>
                        <li><strong>Speed of sound:</strong> v = 331.3 + 0.606 √ó T (m/s) where T is temperature in ¬∞C</li>
                        <li><strong>Effective length:</strong> L_eff = v / (2 √ó f)</li>
                        <li><strong>End correction:</strong> Œ¥ = 0.6 √ó diameter (acoustic correction)</li>
                        <li><strong>Hole position:</strong> Position = L_eff - Œ¥ (from blowing edge)</li>
                    </ul>

                    <h3>Traditional Intervals:</h3>
                    <ul>
                        <li><strong>Perfect Fifth (3/2):</strong> Up 7 semitones, ratio 1.5</li>
                        <li><strong>Perfect Fourth (4/3):</strong> Up 5 semitones, ratio 1.333</li>
                        <li><strong>Major Third (5/4):</strong> Up 4 semitones, ratio 1.25</li>
                        <li><strong>Minor Third (6/5):</strong> Up 3 semitones, ratio 1.2</li>
                        <li><strong>Major Second (9/8):</strong> Up 2 semitones, ratio 1.125</li>
                    </ul>

                    <div style="background: #fff3cd; border: 3px solid #856404; border-radius: 8px; padding: 20px; margin-top: 20px;">
                        <h3 style="color: #856404; margin-bottom: 15px;">‚ö†Ô∏è Empirical Approach for Flute Crafters</h3>
                        <p style="color: #856404;"><strong>Important:</strong> This calculator provides theoretical positions, but flute making requires an empirical approach:</p>
                        <ul style="color: #856404;">
                            <li><strong>Start small:</strong> Begin by drilling holes smaller than calculated</li>
                            <li><strong>Test and adjust:</strong> Gradually enlarge each hole while testing the pitch</li>
                            <li><strong>Work systematically:</strong> Start from the lowest pitch (furthest hole) and move toward the highest (closest to blowing edge)</li>
                            <li><strong>Fine-tune:</strong> Small adjustments in hole size significantly affect pitch</li>
                        </ul>
                    </div>
                </div>
            </div>

            <div class="input-section">
                <h3>Input Parameters</h3>
                <div class="input-grid">
                    <div class="input-group">
                        <label for="simple-base-frequency">Base Frequency (Hz):</label>
                        <input type="number" id="simple-base-frequency" value="440" min="100" max="1000" step="1" oninput="updateSimpleInputs()">
                        <div class="input-hint">Fundamental frequency of your bamboo (A4 = 440 Hz, D4 = 293.66 Hz, G4 = 392 Hz)</div>
                    </div>
                    <div class="input-group">
                        <label for="simple-diameter">Inner Diameter (mm):</label>
                        <input type="number" id="simple-diameter" value="19" min="10" max="50" step="0.5" oninput="updateSimpleInputs()">
                        <div class="input-hint">Internal bore diameter of the flute</div>
                    </div>
                    <div class="input-group">
                        <label for="simple-temp">Temperature (¬∞C):</label>
                        <input type="number" id="simple-temp" value="20" min="-10" max="40" step="1" oninput="updateSimpleInputs()">
                        <div class="input-hint">Ambient temperature (affects speed of sound)</div>
                    </div>
                    <div class="input-group">
                        <label for="simple-holes">Number of Holes:</label>
                        <select id="simple-holes" onchange="onHoleNumberChange()">
                            <option value="4">4 holes (ultra minimaliste)</option>
                            <option value="5">5 holes (super traditionnel)</option>
                            <option value="6" selected>6 holes (le plus traditionnel)</option>
                            <option value="7">7 holes (rare)</option>
                            <option value="8">8 holes</option>
                        </select>
                    </div>
                </div>
                <button id="simple-calculate-button" class="calculate-button" onclick="calculateSimple()">Calculate Positions</button>
            </div>

            <div id="simple-model-selection" class="input-section" style="display: none;">
                <h3 id="model-selection-title">Select Xiao Model</h3>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 8px; color: #5d4a37; font-weight: bold;">Choose a model:</label>
                    <select id="simple-model" onchange="onModelChange()" style="width: 100%; padding: 12px; border: 2px solid #d4b896; border-radius: 8px; font-size: 1em; background: #fffcf7; font-family: 'Georgia', 'Palatino', serif;">
                        <option value="">-- Select a model --</option>
                    </select>
                </div>
                <div id="model-description" style="background: #fff8f0; padding: 20px; border-radius: 8px; border-left: 4px solid #8b6f47; display: none;">
                    <!-- Model description will be inserted here -->
                </div>
            </div>

            <div id="simple-interactive" class="input-section" style="display: none;">
                <h3>Build Your Scale - Hole by Hole</h3>
                <div id="simple-hole-builder">
                    <!-- Dynamic content will be inserted here -->
                </div>
            </div>

            <div id="simple-results" class="results-section hidden">
                <h3>Calculated Hole Positions</h3>
                <button class="visualization-button" onclick="showVisualization()">üëÅÔ∏è Visualisation de la fl√ªte</button>
                <table id="simple-table">
                    <thead>
                        <tr>
                            <th>Trou</th>
                            <th>Distance from Blowing Edge (mm)</th>
                            <th>Distance to Next Hole (mm)</th>
                            <th>Interval</th>
                            <th>Note</th>
                            <th>Frequency (Hz)</th>
                        </tr>
                    </thead>
                    <tbody id="simple-tbody">
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Acoustical Physics Method Tab -->
        <div id="acoustical" class="tab-content">
            <div class="algorithm-explanation">
                <div class="algorithm-explanation-header" onclick="toggleAlgorithm('acoustical-algo')">
                    <h2>Acoustical Physics Method</h2>
                    <span class="algorithm-explanation-toggle" id="acoustical-algo-toggle">‚ñº</span>
                </div>
                <div class="algorithm-explanation-content" id="acoustical-algo-content">
                    <div class="algorithm-inputs" id="acoustical-algo-inputs">
                        <strong>Current Inputs:</strong><br>
                        Base Frequency: <span id="acoustical-input-frequency">293.66</span> Hz<br>
                        Inner Diameter: <span id="acoustical-input-diameter">19</span> mm<br>
                        Temperature: <span id="acoustical-input-temp">20</span> ¬∞C<br>
                        Number of Holes: <span id="acoustical-input-holes">6</span>
                    </div>
                    <p>This method uses fundamental acoustic principles to calculate hole positions based on the speed of sound, desired frequencies, and the physical properties of the flute.</p>
                    
                    <h3>How it Works:</h3>
                    <ul>
                        <li>Uses the relationship: <span class="formula">f = v / (2 √ó L)</span> where f is frequency, v is speed of sound, L is effective length</li>
                        <li>Accounts for end corrections based on bore diameter</li>
                        <li>Considers temperature and humidity effects on sound velocity</li>
                        <li>More accurate for precise tuning requirements</li>
                    </ul>

                    <h3>Calculation Details:</h3>
                    <p>The effective length for each note is calculated as:</p>
                    <ul>
                        <li><strong>Speed of sound:</strong> v ‚âà 343 m/s (at 20¬∞C)</li>
                        <li><strong>End correction:</strong> Œ¥ ‚âà 0.6 √ó diameter</li>
                        <li><strong>Effective length:</strong> L_eff = v / (2 √ó f) - Œ¥</li>
                        <li><strong>Hole position:</strong> Distance from embouchure hole</li>
                    </ul>
                </div>
            </div>

            <div class="input-section">
                <h3>Input Parameters</h3>
                <div class="input-grid">
                    <div class="input-group">
                        <label for="acoustical-frequency">Base Frequency (Hz):</label>
                        <input type="number" id="acoustical-frequency" value="293.66" min="100" max="1000" step="1" oninput="updateAcousticalInputs()">
                        <div class="input-hint">Fundamental frequency (D4 = 293.66 Hz)</div>
                    </div>
                    <div class="input-group">
                        <label for="acoustical-diameter">Inner Diameter (mm):</label>
                        <input type="number" id="acoustical-diameter" value="19" min="10" max="50" step="0.5" oninput="updateAcousticalInputs()">
                        <div class="input-hint">Internal bore diameter</div>
                    </div>
                    <div class="input-group">
                        <label for="acoustical-temp">Temperature (¬∞C):</label>
                        <input type="number" id="acoustical-temp" value="20" min="-10" max="40" step="1" oninput="updateAcousticalInputs()">
                        <div class="input-hint">Ambient temperature affects sound velocity</div>
                    </div>
                    <div class="input-group">
                        <label for="acoustical-holes">Number of Holes:</label>
                        <select id="acoustical-holes" onchange="updateAcousticalInputs()">
                            <option value="5">5 holes</option>
                            <option value="6" selected>6 holes</option>
                            <option value="7">7 holes</option>
                            <option value="8">8 holes</option>
                        </select>
                    </div>
                </div>
                <button class="calculate-button" onclick="calculateAcoustical()">Calculate Positions</button>
            </div>

            <div id="acoustical-results" class="results-section hidden">
                <h3>Calculated Hole Positions</h3>
                <table id="acoustical-table">
                    <thead>
                        <tr>
                            <th>Trou</th>
                            <th>Distance from Blowing Edge (mm)</th>
                            <th>Note</th>
                            <th>Frequency (Hz)</th>
                        </tr>
                    </thead>
                    <tbody id="acoustical-tbody">
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Benade's Formula Tab -->
        <div id="benade" class="tab-content">
            <div class="algorithm-explanation">
                <div class="algorithm-explanation-header" onclick="toggleAlgorithm('benade-algo')">
                    <h2>Benade's Formula</h2>
                    <span class="algorithm-explanation-toggle" id="benade-algo-toggle">‚ñº</span>
                </div>
                <div class="algorithm-explanation-content" id="benade-algo-content">
                    <div class="algorithm-inputs" id="benade-algo-inputs">
                        <strong>Current Inputs:</strong><br>
                        Fundamental Length: <span id="benade-input-length">400</span> mm<br>
                        Bore Diameter: <span id="benade-input-bore">19</span> mm<br>
                        Hole Diameter: <span id="benade-input-hole-dia">8</span> mm<br>
                        Wall Thickness: <span id="benade-input-wall">3</span> mm<br>
                        Number of Holes: <span id="benade-input-holes">6</span>
                    </div>
                    <p>Developed by physicist Arthur Benade, this advanced method provides highly accurate hole positions by considering the acoustic impedance and coupling between holes.</p>
                    
                    <h3>How it Works:</h3>
                    <ul>
                        <li>Accounts for hole diameter relative to bore diameter</li>
                        <li>Considers the acoustic mass and compliance of the air column</li>
                        <li>Uses the chimney height (wall thickness) in calculations</li>
                        <li>Most accurate method for professional instrument making</li>
                    </ul>

                    <h3>Calculation Details:</h3>
                    <p>The position calculation involves:</p>
                    <ul>
                        <li><strong>Cutoff frequency:</strong> f_c = v / (2 √ó L)</li>
                        <li><strong>Hole impedance:</strong> Z = f(d, D, t) where d=hole diameter, D=bore diameter, t=wall thickness</li>
                        <li><strong>Position correction:</strong> Adjusted based on hole coupling effects</li>
                        <li><strong>Formula:</strong> <span class="formula">L_n = (v / 2f_n) √ó [1 + K(d/D)¬≤]</span></li>
                    </ul>
                </div>
            </div>

            <div class="input-section">
                <h3>Input Parameters</h3>
                <div class="input-grid">
                    <div class="input-group">
                        <label for="benade-length">Fundamental Length (mm):</label>
                        <input type="number" id="benade-length" value="400" min="100" max="1000" step="1" oninput="updateBenadeInputs()">
                        <div class="input-hint">Distance from blowing edge to the end</div>
                    </div>
                    <div class="input-group">
                        <label for="benade-bore">Bore Diameter (mm):</label>
                        <input type="number" id="benade-bore" value="19" min="10" max="50" step="0.5" oninput="updateBenadeInputs()">
                        <div class="input-hint">Internal diameter of the tube</div>
                    </div>
                    <div class="input-group">
                        <label for="benade-hole-dia">Hole Diameter (mm):</label>
                        <input type="number" id="benade-hole-dia" value="8" min="3" max="20" step="0.5" oninput="updateBenadeInputs()">
                        <div class="input-hint">Diameter of the finger holes</div>
                    </div>
                    <div class="input-group">
                        <label for="benade-wall">Wall Thickness (mm):</label>
                        <input type="number" id="benade-wall" value="3" min="1" max="10" step="0.5" oninput="updateBenadeInputs()">
                        <div class="input-hint">Thickness of the flute wall</div>
                    </div>
                    <div class="input-group">
                        <label for="benade-holes">Number of Holes:</label>
                        <select id="benade-holes" onchange="updateBenadeInputs()">
                            <option value="5">5 holes</option>
                            <option value="6" selected>6 holes</option>
                            <option value="7">7 holes</option>
                            <option value="8">8 holes</option>
                        </select>
                    </div>
                </div>
                <button class="calculate-button" onclick="calculateBenade()">Calculate Positions</button>
            </div>

            <div id="benade-results" class="results-section hidden">
                <h3>Calculated Hole Positions</h3>
                <table id="benade-table">
                    <thead>
                        <tr>
                            <th>Trou</th>
                            <th>Distance from Blowing Edge (mm)</th>
                            <th>Corrected Position (mm)</th>
                            <th>Note</th>
                        </tr>
                    </thead>
                    <tbody id="benade-tbody">
                    </tbody>
                </table>
            </div>
        </div>

        <footer>
            <p>Crafted with care for flute makers worldwide üåø</p>
        </footer>
    </div>

    <!-- Visualization Modal -->
    <div id="visualization-modal" class="modal-backdrop" onclick="closeVisualizationIfBackdrop(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <button class="modal-close" onclick="closeVisualization()">√ó</button>
            <h2 style="color: #6d5738; margin-bottom: 20px; text-align: center;">Visualisation de la Fl√ªte</h2>
            <div id="flute-drawing-container">
                <!-- SVG will be inserted here -->
            </div>
        </div>
    </div>

    <script>
        // Toggle algorithm explanation
        function toggleAlgorithm(algoId) {
            const content = document.getElementById(algoId + '-content');
            const toggle = document.getElementById(algoId + '-toggle');
            
            content.classList.toggle('expanded');
            toggle.classList.toggle('expanded');
        }

        // Update Simple inputs in real-time
        function updateSimpleInputs() {
            document.getElementById('simple-input-frequency').textContent = document.getElementById('simple-base-frequency').value;
            document.getElementById('simple-input-diameter').textContent = document.getElementById('simple-diameter').value;
            document.getElementById('simple-input-temp').textContent = document.getElementById('simple-temp').value;
            document.getElementById('simple-input-holes').textContent = document.getElementById('simple-holes').value;
            
            // Auto-recalculate if a model is already selected
            if (currentSelectedModel !== null) {
                calculateWithModel(currentSelectedModel);
            }
        }

        // Handle hole number change
        function onHoleNumberChange() {
            updateSimpleInputs();
            const numHoles = parseInt(document.getElementById('simple-holes').value);
            const calcButton = document.getElementById('simple-calculate-button');
            const modelSelection = document.getElementById('simple-model-selection');
            const modelSelect = document.getElementById('simple-model');
            const modelTitle = document.getElementById('model-selection-title');
            
            // Reset model selection
            modelSelect.innerHTML = '<option value="">-- Select a model --</option>';
            document.getElementById('model-description').style.display = 'none';
            document.getElementById('simple-interactive').style.display = 'none';
            document.getElementById('simple-results').classList.add('hidden');
            currentSelectedModel = null; // Reset current model
            
            // Populate model options based on number of holes
            let hasModels = false;
            
            if (numHoles === 8) {
                modelTitle.textContent = 'Select Xiao Model (8 holes)';
                modelSelect.innerHTML += '<option value="pentatonic_8">Pentatonic Majeure Traditionnelle (la plus courante)</option>';
                modelSelect.innerHTML += '<option value="heptatonic_8">Heptatonique Traditionnelle (moins courante)</option>';
                modelSelect.innerHTML += '<option value="diatonic_8">Diatonique Moderne (occidentalis√©e)</option>';
                hasModels = true;
            } else if (numHoles === 7) {
                modelTitle.textContent = 'Select Xiao Model (7 holes)';
                modelSelect.innerHTML += '<option value="pentatonic_7a">Pentatonique + 4e diatonique (Variante A)</option>';
                modelSelect.innerHTML += '<option value="pentatonic_7b">Pentatonique + 7e mineure (Variante B)</option>';
                hasModels = true;
            } else if (numHoles === 6) {
                modelTitle.textContent = 'Select Xiao Model (6 holes)';
                modelSelect.innerHTML += '<option value="pentatonic_6">Pentatonique traditionnelle (le plus courant)</option>';
                hasModels = true;
            } else if (numHoles === 5) {
                modelTitle.textContent = 'Select Xiao Model (5 holes)';
                modelSelect.innerHTML += '<option value="pentatonic_5">Pentatonique pur (super traditionnel)</option>';
                hasModels = true;
            } else if (numHoles === 4) {
                modelTitle.textContent = 'Select Xiao Model (4 holes)';
                modelSelect.innerHTML += '<option value="pentatonic_4">Ultra minimaliste</option>';
                hasModels = true;
            }
            
            if (hasModels) {
                // Show model selection for these hole configurations
                modelSelection.style.display = 'block';
                calcButton.style.display = 'none';
            } else {
                // Hide model selection and show calculate button for other numbers
                modelSelection.style.display = 'none';
                calcButton.style.display = 'block';
            }
        }

        // Model definitions for different hole configurations
        const xiaoModels = {
            // 8 holes models
            pentatonic_8: {
                name: "Xiao Pentatonique Majeure Traditionnelle",
                holes: 8,
                description: `
                    <h3 style="color: #6d5738; margin-bottom: 15px;">üü¶ SC√âNARIO 1 ‚Äî La xiao pentatonique majeure traditionnelle (la plus courante)</h3>
                    <p><strong>Gamme :</strong> Gong ‚Äì Shang ‚Äì Jue ‚Äì Zhi ‚Äì Yu</p>
                    <p>Pentatonique majeure chinoise ‚Üí √©quivalent de la pentatonique majeure occidentale.</p>
                    <h4 style="color: #8b6f47; margin-top: 15px; margin-bottom: 10px;">üéµ Les 8 notes (avec intervalles) :</h4>
                    <ul style="line-height: 1.8;">
                        <li>Tonique (0)</li>
                        <li>M2 (2)</li>
                        <li>M2 (4)</li>
                        <li>m3 (7)</li>
                        <li>M2 (9)</li>
                        <li>m3 (12)</li>
                        <li>M2 (14) ‚Üê facultatif selon les mod√®les</li>
                        <li>M2 (16)</li>
                    </ul>
                    <p><strong>‚úî R√©sum√© des intervalles :</strong> +2 ‚Äì +2 ‚Äì +3 ‚Äì +2 ‚Äì +3 ‚Äì +2 ‚Äì +2</p>
                    <p style="margin-top: 10px; font-style: italic; color: #6d5738;">C'est la structure 90% des xiao du commerce. Elle donne une m√©lodie "flottante", typique de la musique chinoise.</p>
                `,
                intervals: [0, 2, 4, 7, 9, 12, 14, 16] // semitones from base
            },
            heptatonic_8: {
                name: "Xiao Heptatonique Traditionnelle",
                holes: 8,
                description: `
                    <h3 style="color: #6d5738; margin-bottom: 15px;">üü¶ SC√âNARIO 2 ‚Äî Xiao heptatonique traditionnelle (moins courante)</h3>
                    <p>Dans certaines musiques rituelles ou locales, la xiao est accord√©e avec une gamme heptatonique ancienne, proche du mode mixolydien ou dorien selon la r√©gion.</p>
                    <h4 style="color: #8b6f47; margin-top: 15px; margin-bottom: 10px;">üéµ Les 8 notes (avec intervalles) :</h4>
                    <ul style="line-height: 1.8;">
                        <li>Tonique (0)</li>
                        <li>M2 (2)</li>
                        <li>M2 (4)</li>
                        <li>m2 (5)</li>
                        <li>M2 (7)</li>
                        <li>M2 (9)</li>
                        <li>m2 (10)</li>
                        <li>M2 (12)</li>
                    </ul>
                    <p><strong>‚úî R√©sum√© des intervalles :</strong> +2 ‚Äì +2 ‚Äì +1 ‚Äì +2 ‚Äì +2 ‚Äì +1 ‚Äì +2</p>
                    <p style="margin-top: 10px; font-style: italic; color: #6d5738;">On est proche d'une gamme majeure mais avec une 4e augment√©e et une 7e mineure. C'est rare mais historiquement authentique.</p>
                `,
                intervals: [0, 2, 4, 5, 7, 9, 10, 12]
            },
            diatonic_8: {
                name: "Xiao Diatonique Moderne",
                holes: 8,
                description: `
                    <h3 style="color: #6d5738; margin-bottom: 15px;">üü¶ SC√âNARIO 3 ‚Äî Xiao diatonique moderne (occidentalis√©e)</h3>
                    <p>Utilis√©e par certains musiciens contemporains pour jouer des m√©lodies occidentales. Ici on force une gamme majeure compl√®te.</p>
                    <h4 style="color: #8b6f47; margin-top: 15px; margin-bottom: 10px;">üéµ Les 8 notes (avec intervalles) :</h4>
                    <ul style="line-height: 1.8;">
                        <li>Tonique (0)</li>
                        <li>M2 (2)</li>
                        <li>M2 (4)</li>
                        <li>m2 (5)</li>
                        <li>M2 (7)</li>
                        <li>M2 (9)</li>
                        <li>M2 (11)</li>
                        <li>m2 (12)</li>
                    </ul>
                    <p><strong>‚úî R√©sum√© des intervalles :</strong> +2 ‚Äì +2 ‚Äì +1 ‚Äì +2 ‚Äì +2 ‚Äì +2 ‚Äì +1</p>
                    <p style="margin-top: 10px; font-style: italic; color: #6d5738;">C'est jouable, mais ergonomiquement difficile. Les trous se superposent souvent.</p>
                `,
                intervals: [0, 2, 4, 5, 7, 9, 11, 12]
            },
            // 7 holes models
            pentatonic_7a: {
                name: "Xiao 7 trous - Pentatonique + 4e diatonique",
                holes: 7,
                description: `
                    <h3 style="color: #6d5738; margin-bottom: 15px;">üü© Xiao √† 7 trous - Variante A (pentatonique + 4e diatonique)</h3>
                    <p>Le 7e trou apporte une note de passage suppl√©mentaire, enrichissant la gamme pentatonique traditionnelle.</p>
                    <h4 style="color: #8b6f47; margin-top: 15px; margin-bottom: 10px;">üéµ Les 7 notes (avec intervalles) :</h4>
                    <ul style="line-height: 1.8;">
                        <li>Tonique (0)</li>
                        <li>M2 (2)</li>
                        <li>M2 (4)</li>
                        <li>m3 (7)</li>
                        <li>m2 (8)</li>
                        <li>M2 (10)</li>
                        <li>m3 (13)</li>
                    </ul>
                    <p><strong>‚úî R√©sum√© des intervalles :</strong> +2 ‚Äì +2 ‚Äì +3 ‚Äì +1 ‚Äì +2 ‚Äì +3</p>
                    <p style="margin-top: 10px; font-style: italic; color: #6d5738;">Assez peu courant, mais attest√© dans certains styles anciens.</p>
                `,
                intervals: [0, 2, 4, 7, 8, 10, 13]
            },
            pentatonic_7b: {
                name: "Xiao 7 trous - Pentatonique + 7e mineure",
                holes: 7,
                description: `
                    <h3 style="color: #6d5738; margin-bottom: 15px;">üü© Xiao √† 7 trous - Variante B (pentatonique + 7e mineure)</h3>
                    <p>Cette variante ajoute une 7e mineure √† la gamme pentatonique, offrant un doigt√© alternatif pour stabiliser certains micro-intervalles.</p>
                    <h4 style="color: #8b6f47; margin-top: 15px; margin-bottom: 10px;">üéµ Les 7 notes (avec intervalles) :</h4>
                    <ul style="line-height: 1.8;">
                        <li>Tonique (0)</li>
                        <li>M2 (2)</li>
                        <li>M2 (4)</li>
                        <li>m3 (7)</li>
                        <li>M2 (9)</li>
                        <li>m2 (10)</li>
                        <li>m3 (13)</li>
                    </ul>
                    <p><strong>‚úî R√©sum√© des intervalles :</strong> +2 ‚Äì +2 ‚Äì +3 ‚Äì +2 ‚Äì +1 ‚Äì +3</p>
                    <p style="margin-top: 10px; font-style: italic; color: #6d5738;">Rare mais attest√© dans certains styles anciens et musiques traditionnelles locales.</p>
                `,
                intervals: [0, 2, 4, 7, 9, 10, 13]
            },
            // 6 holes model
            pentatonic_6: {
                name: "Xiao 6 trous - Pentatonique traditionnelle",
                holes: 6,
                description: `
                    <h3 style="color: #6d5738; margin-bottom: 15px;">üü¶ Xiao √† 6 trous (le plus traditionnel)</h3>
                    <p>Pendant la plus grande partie de l'histoire, la xiao n'avait que 6 trous.</p>
                    <p><strong>‚úî Typiquement associ√©s √† la gamme pentatonique :</strong></p>
                    <p>Gong ‚Äì Shang ‚Äì Jue ‚Äì Zhi ‚Äì Yu ‚Üí donc : M2 ‚Äì M2 ‚Äì m3 ‚Äì M2 ‚Äì m3</p>
                    <h4 style="color: #8b6f47; margin-top: 15px; margin-bottom: 10px;">üéµ 6 trous = 5 intervalles + octave</h4>
                    <ul style="line-height: 1.8;">
                        <li>Tonique (0)</li>
                        <li>M2 (2)</li>
                        <li>M2 (4)</li>
                        <li>m3 (7)</li>
                        <li>M2 (9)</li>
                        <li>m3 (12)</li>
                    </ul>
                    <p><strong>‚úî R√©sum√© des intervalles :</strong> +2 ‚Äì +2 ‚Äì +3 ‚Äì +2 ‚Äì +3</p>
                    <p style="margin-top: 10px; font-style: italic; color: #6d5738;">C'est le mod√®le le plus ancien, le plus ergonomique, celui des xiao du Sud (nanxiao), celui utilis√© dans beaucoup de musiques traditionnelles. C'est le sc√©nario le plus courant pour "moins de 8 trous".</p>
                `,
                intervals: [0, 2, 4, 7, 9, 12]
            },
            // 5 holes model
            pentatonic_5: {
                name: "Xiao 5 trous - Pentatonique pur",
                holes: 5,
                description: `
                    <h3 style="color: #6d5738; margin-bottom: 15px;">üü• Xiao √† 5 trous (super traditionnel, le vrai pentatonique brut)</h3>
                    <p>C'est une xiao primordiale, tr√®s √©pur√©e. Chaque trou correspond √† une note de la pentatonique compl√®te, sans "notes de passage".</p>
                    <h4 style="color: #8b6f47; margin-top: 15px; margin-bottom: 10px;">üéµ Structure exacte :</h4>
                    <ul style="line-height: 1.8;">
                        <li>Tonique (0)</li>
                        <li>M2 (2)</li>
                        <li>M2 (4)</li>
                        <li>m3 (7)</li>
                        <li>M2 (9)</li>
                        <li>(+3 pour octave = 12)</li>
                    </ul>
                    <p><strong>‚úî R√©sum√© des intervalles :</strong> +2 ‚Äì +2 ‚Äì +3 ‚Äì +2 (+ octave)</p>
                    <p style="margin-top: 10px; font-style: italic; color: #6d5738;">On a vraiment que la pentatonique, rien d'autre. C'est courant dans certaines r√©gions du Sichuan, dans les instruments de c√©r√©monie, dans les fl√ªtes anciennes en bambou massif. Tr√®s authentique, plus simple et tr√®s ergonomique. Beaucoup plus facile √† fabriquer : les trous sont bien espac√©s.</p>
                `,
                intervals: [0, 2, 4, 7, 9]
            },
            // 4 holes model
            pentatonic_4: {
                name: "Xiao 4 trous - Ultra minimaliste",
                holes: 4,
                description: `
                    <h3 style="color: #6d5738; margin-bottom: 15px;">üüß Xiao √† 4 trous (ultra minimaliste)</h3>
                    <p>Rare mais attest√©e dans certaines traditions chamaniques, des fl√ªtes de m√©ditation ou fun√©raires, des instruments folkloriques d√©pouill√©s.</p>
                    <h4 style="color: #8b6f47; margin-top: 15px; margin-bottom: 10px;">üéµ Structure :</h4>
                    <p>C'est une pentatonique r√©duite, souvent :</p>
                    <ul style="line-height: 1.8;">
                        <li>Tonique (0)</li>
                        <li>M2 (2)</li>
                        <li>m3 (5)</li>
                        <li>M2 (7)</li>
                        <li>(+3 pour octave si besoin)</li>
                    </ul>
                    <p><strong>‚úî R√©sum√© des intervalles :</strong> +2 ‚Äì +3 ‚Äì +2</p>
                    <p style="margin-top: 10px; font-style: italic; color: #6d5738;">On retire deux degr√©s de la pentatonique. Ce sont des fl√ªtes "√† r√¥le", pas m√©lodiques au sens occidental.</p>
                `,
                intervals: [0, 2, 5, 7]
            }
        };

        // Handle model change
        function onModelChange() {
            const modelKey = document.getElementById('simple-model').value;
            const descDiv = document.getElementById('model-description');
            
            if (modelKey === '') {
                descDiv.style.display = 'none';
                document.getElementById('simple-results').classList.add('hidden');
                currentSelectedModel = null;
                return;
            }
            
            const model = xiaoModels[modelKey];
            currentSelectedModel = model; // Store current model
            descDiv.innerHTML = model.description;
            descDiv.style.display = 'block';
            
            // Automatically calculate when model is selected
            calculateWithModel(model);
        }

        // Check if a hole pair should be excluded from overlap warnings
        // i is the index of the first hole in the pair (0-based)
        function isSpecialHolePair(holeIndex, totalHoles) {
            // For 8 holes: 
            // - hole 1 (index 0) is for pinky (left or right)
            // - hole 8 (index 7) is back hole
            if (totalHoles === 8) {
                // Skip warning for hole 1 to hole 2 (index 0)
                if (holeIndex === 0) return true;
                // Skip warning for hole 7 to hole 8 (index 6)
                if (holeIndex === 6) return true;
            }
            
            // For 7 holes:
            // - hole 7 (index 6) is back hole
            if (totalHoles === 7) {
                // Skip warning for hole 6 to hole 7 (index 5)
                if (holeIndex === 5) return true;
            }
            
            return false;
        }

        // Calculate positions based on selected model
        function calculateWithModel(model) {
            const baseFreq = parseFloat(document.getElementById('simple-base-frequency').value);
            const diameter = parseFloat(document.getElementById('simple-diameter').value);
            const temp = parseFloat(document.getElementById('simple-temp').value);
            
            // Speed of sound in air (temperature dependent)
            const speedOfSound = (331.3 + 0.606 * temp) * 1000; // mm/s
            const endCorrection = 0.6 * diameter;
            
            const tbody = document.getElementById('simple-tbody');
            tbody.innerHTML = '';
            
            // Calculate positions for each hole
            const positions = [];
            const frequencies = [];
            
            for (let i = 0; i < model.intervals.length; i++) {
                const semitone = model.intervals[i];
                const frequency = baseFreq * Math.pow(2, semitone / 12);
                frequencies.push(frequency);
                
                const effectiveLength = (speedOfSound / (2 * frequency)) - endCorrection;
                positions.push(effectiveLength);
            }
            
            // Build table rows with warnings about hole overlap
            let hasOverlapWarning = false;
            const numHoles = model.intervals.length;
            
            for (let i = 0; i < numHoles; i++) {
                const frequency = frequencies[i];
                const position = positions[i];
                const note = getNoteName(frequency);
                const semitone = model.intervals[i];
                
                // Calculate distance to next hole
                let distanceCell = '';
                let warningCell = '';
                if (i < numHoles - 1) {
                    const distance = Math.abs(positions[i] - positions[i + 1]);
                    distanceCell = distance.toFixed(2);
                    
                    // Determine if we should check for overlap warnings
                    // Skip warning checks for special holes:
                    // - For 8 holes: hole 1 is for pinky (left/right), hole 8 is back hole
                    // - For 7 holes: hole 7 is back hole
                    const shouldCheckOverlap = !isSpecialHolePair(i, numHoles);
                    
                    // Check for overlap risk (holes too close, less than 10mm)
                    if (shouldCheckOverlap) {
                        if (distance < 10) {
                            warningCell = '<span class="warning-indicator warning-limit">‚ö† Risque de superposition</span>';
                            hasOverlapWarning = true;
                        } else if (distance < 15) {
                            warningCell = '<span class="warning-indicator warning-difficult">‚ö† Trous rapproch√©s</span>';
                        } else {
                            warningCell = '<span class="warning-indicator warning-comfortable">‚úì OK</span>';
                        }
                    } else {
                        // For special holes, just show OK without distance checking
                        warningCell = '<span class="warning-indicator warning-comfortable">‚úì OK</span>';
                    }
                } else {
                    distanceCell = '‚Äî';
                    warningCell = '';
                }
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${i + 1}</td>
                    <td>${position.toFixed(2)}</td>
                    <td>${distanceCell}</td>
                    <td>+${semitone} demi-tons</td>
                    <td>${note} ${warningCell}</td>
                    <td>${frequency.toFixed(2)}</td>
                `;
                tbody.appendChild(row);
            }
            
            // Add empirical warning if there's overlap
            if (hasOverlapWarning) {
                const warningRow = document.createElement('tr');
                warningRow.innerHTML = `
                    <td colspan="6" style="background: #fff3cd; color: #856404; font-weight: bold; padding: 15px;">
                        ‚ö†Ô∏è <strong>M√©thode empirique recommand√©e :</strong> En cas de risque de superposition des trous, 
                        il faut remonter le prochain trou et l'√©largir. Cette approche empirique permet d'ajuster 
                        la position et le diam√®tre des trous pour √©viter les chevauchements tout en maintenant l'accord souhait√©.
                    </td>
                `;
                tbody.appendChild(warningRow);
            }
            
            // Store data for visualization
            currentFluteData = {
                positions: positions,
                numHoles: numHoles,
                diameter: diameter
            };
            
            document.getElementById('simple-results').classList.remove('hidden');
        }

        // Update Acoustical inputs in real-time
        function updateAcousticalInputs() {
            document.getElementById('acoustical-input-frequency').textContent = document.getElementById('acoustical-frequency').value;
            document.getElementById('acoustical-input-diameter').textContent = document.getElementById('acoustical-diameter').value;
            document.getElementById('acoustical-input-temp').textContent = document.getElementById('acoustical-temp').value;
            document.getElementById('acoustical-input-holes').textContent = document.getElementById('acoustical-holes').value;
        }

        // Update Benade inputs in real-time
        function updateBenadeInputs() {
            document.getElementById('benade-input-length').textContent = document.getElementById('benade-length').value;
            document.getElementById('benade-input-bore').textContent = document.getElementById('benade-bore').value;
            document.getElementById('benade-input-hole-dia').textContent = document.getElementById('benade-hole-dia').value;
            document.getElementById('benade-input-wall').textContent = document.getElementById('benade-wall').value;
            document.getElementById('benade-input-holes').textContent = document.getElementById('benade-holes').value;
        }

        // Tab switching functionality
        function switchTab(tabName) {
            // Hide all tabs
            const tabs = document.querySelectorAll('.tab-content');
            tabs.forEach(tab => tab.classList.remove('active'));
            
            // Deactivate all buttons
            const buttons = document.querySelectorAll('.tab-button');
            buttons.forEach(button => button.classList.remove('active'));
            
            // Show selected tab
            document.getElementById(tabName).classList.add('active');
            
            // Activate corresponding button
            event.target.classList.add('active');
        }

        // Note names for reference
        const noteNames = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
        
        // Hole distance constraints (center to center) in mm
        // Index 0 = hole 1‚Üí2, Index 1 = hole 2‚Üí3, etc.
        const holeDistanceConstraints = [
            { comfortable: { min: 18, max: 22 }, difficult: { min: 23, max: 26 }, limit: 28 }, // Hole 1‚Üí2
            { comfortable: { min: 20, max: 25 }, difficult: { min: 26, max: 30 }, limit: 32 }, // Hole 2‚Üí3
            { comfortable: { min: 22, max: 28 }, difficult: { min: 29, max: 33 }, limit: 35 }, // Hole 3‚Üí4
            { comfortable: { min: 20, max: 25 }, difficult: { min: 26, max: 30 }, limit: 32 }, // Hole 4‚Üí5
            { comfortable: { min: 18, max: 23 }, difficult: { min: 24, max: 28 }, limit: 30 }, // Hole 5‚Üí6
            { comfortable: { min: 16, max: 20 }, difficult: { min: 21, max: 24 }, limit: 26 }, // Hole 6‚Üí7
            { comfortable: { min: 14, max: 18 }, difficult: { min: 19, max: 22 }, limit: 24 }  // Hole 7‚Üí8
        ];
        
        function getNoteFromSemitones(baseSemitones, offset) {
            const totalSemitones = (baseSemitones + offset) % 12;
            return noteNames[totalSemitones];
        }

        // Function to evaluate hole distance and return warning indicator
        function evaluateHoleDistance(holeIndex, distance) {
            if (holeIndex >= holeDistanceConstraints.length) {
                return ''; // No constraint for this hole pair
            }
            
            const constraint = holeDistanceConstraints[holeIndex];
            const dist = Math.abs(distance);
            
            if (dist >= constraint.comfortable.min && dist <= constraint.comfortable.max) {
                return `<span class="warning-indicator warning-comfortable">‚úì Comfortable</span>`;
            } else if (dist >= constraint.difficult.min && dist <= constraint.difficult.max) {
                return `<span class="warning-indicator warning-difficult">‚ö† Difficult</span>`;
            } else if (dist > constraint.limit) {
                return `<span class="warning-indicator warning-limit">‚ö† Exceeds limit (>${constraint.limit}mm)</span>`;
            } else {
                return `<span class="warning-indicator warning-difficult">‚ö† Below range</span>`;
            }
        }

        // Available interval ratios for Sanfen Sunyi method
        const intervalRatios = [
            { name: 'Perfect Fifth (San Fen Sun Yi)', ratio: 3/2, semitones: 7 },
            { name: 'Perfect Fourth (San Fen Yi Yi)', ratio: 4/3, semitones: 5 },
            { name: 'Major Third', ratio: 5/4, semitones: 4 },
            { name: 'Minor Third', ratio: 6/5, semitones: 3 },
            { name: 'Major Second', ratio: 9/8, semitones: 2 },
            { name: 'Minor Second', ratio: 16/15, semitones: 1 },
            { name: 'Major Sixth', ratio: 5/3, semitones: 9 },
            { name: 'Minor Seventh', ratio: 16/9, semitones: 10 }
        ];

        // State for interactive hole building
        let holeFrequencies = [];
        let selectedIntervals = [];
        let preCalculatedPositions = []; // Store pre-calculated positions for all intervals
        let currentSelectedModel = null; // Track currently selected model for auto-recalculation

        // Simple Ratio Method (Xiao Flute - Sanfen Sunyi)
        function calculateSimple() {
            const baseFreq = parseFloat(document.getElementById('simple-base-frequency').value);
            const diameter = parseFloat(document.getElementById('simple-diameter').value);
            const temp = parseFloat(document.getElementById('simple-temp').value);
            const numHoles = parseInt(document.getElementById('simple-holes').value);
            
            // For 8 holes, use model selection instead
            if (numHoles === 8) {
                alert('Pour 8 trous, veuillez s√©lectionner un mod√®le ci-dessus.');
                return;
            }
            
            // Initialize with base frequency
            holeFrequencies = [baseFreq];
            selectedIntervals = [];
            
            // Pre-calculate all possible positions for each interval
            preCalculatedPositions = calculateAllPossiblePositions(baseFreq, diameter, temp);
            
            // Clear results table
            const tbody = document.getElementById('simple-tbody');
            tbody.innerHTML = '';
            
            // Show interactive builder
            document.getElementById('simple-interactive').style.display = 'block';
            
            // Show results section (but empty initially)
            document.getElementById('simple-results').classList.remove('hidden');
            
            // Build the interactive interface starting from hole 1
            buildHoleSelector(0, numHoles);
        }

        // Pre-calculate positions for all possible interval choices
        function calculateAllPossiblePositions(baseFreq, diameter, temp) {
            const speedOfSound = (331.3 + 0.606 * temp) * 1000; // mm/s
            const endCorrection = 0.6 * diameter;
            
            let positions = [];
            
            // For each hole level, calculate positions for all interval choices
            for (let holeLevel = 0; holeLevel < 8; holeLevel++) {
                positions[holeLevel] = [];
                
                for (let intervalIdx = 0; intervalIdx < intervalRatios.length; intervalIdx++) {
                    const interval = intervalRatios[intervalIdx];
                    const frequency = baseFreq * interval.ratio;
                    const effectiveLength = (speedOfSound / (2 * frequency)) - endCorrection;
                    positions[holeLevel][intervalIdx] = effectiveLength;
                }
            }
            
            return positions;
        }

        function buildHoleSelector(holeIndex, totalHoles) {
            const builder = document.getElementById('simple-hole-builder');
            builder.innerHTML = '';
            
            if (holeIndex >= totalHoles) {
                // All holes configured
                builder.innerHTML = '<p style="color: #6d5738; font-weight: bold;">‚úì All holes configured! The table below shows your custom scale.</p>';
                return;
            }
            
            const currentFreq = holeFrequencies[holeIndex];
            
            const div = document.createElement('div');
            div.innerHTML = `
                <div style="background: #fff8f0; padding: 20px; border-radius: 8px; border: 2px solid #d4b896;">
                    <h4 style="color: #6d5738; margin-bottom: 15px;">Configure Hole ${holeIndex + 1}</h4>
                    <p style="margin-bottom: 10px;"><strong>Current Frequency:</strong> ${currentFreq.toFixed(2)} Hz (${getNoteName(currentFreq)})</p>
                    <label style="display: block; margin-bottom: 8px; color: #5d4a37; font-weight: bold;">Choose next interval:</label>
                    <select id="interval-select-${holeIndex}" style="width: 100%; padding: 12px; border: 2px solid #d4b896; border-radius: 8px; font-size: 1em; background: #fffcf7; font-family: 'Georgia', 'Palatino', serif; margin-bottom: 15px;">
                        ${intervalRatios.map((interval, idx) => {
                            const nextFreq = currentFreq * interval.ratio;
                            const warning = getWarningForInterval(holeIndex, idx);
                            return `<option value="${idx}">${interval.name} ‚Üí ${nextFreq.toFixed(2)} Hz (${getNoteName(nextFreq)}) ${warning}</option>`;
                        }).join('')}
                    </select>
                    <button onclick="selectInterval(${holeIndex}, ${totalHoles})" style="background: linear-gradient(135deg, #8b6f47 0%, #6d5738 100%); color: white; padding: 12px 30px; border: none; border-radius: 8px; font-size: 1em; font-weight: bold; cursor: pointer; font-family: 'Georgia', 'Palatino', serif;">
                        ${holeIndex < totalHoles - 1 ? 'Next Hole ‚Üí' : 'Finish Scale'}
                    </button>
                </div>
            `;
            builder.appendChild(div);
        }

        // Get warning text for an interval choice at a specific hole index
        function getWarningForInterval(holeIndex, intervalIdx) {
            if (holeIndex === 0) {
                return ''; // No warning for first hole
            }
            
            // Get the position of the previous hole
            const diameter = parseFloat(document.getElementById('simple-diameter').value);
            const temp = parseFloat(document.getElementById('simple-temp').value);
            const speedOfSound = (331.3 + 0.606 * temp) * 1000;
            const endCorrection = 0.6 * diameter;
            
            const prevFreq = holeFrequencies[holeIndex];
            const prevPosition = (speedOfSound / (2 * prevFreq)) - endCorrection;
            
            // Get the position of current interval choice
            const interval = intervalRatios[intervalIdx];
            const nextFreq = prevFreq * interval.ratio;
            const nextPosition = (speedOfSound / (2 * nextFreq)) - endCorrection;
            
            const distance = Math.abs(prevPosition - nextPosition);
            
            // Use holeIndex - 1 because we're calculating distance from previous hole
            return getWarningText(holeIndex - 1, distance);
        }

        // Get warning text based on distance
        function getWarningText(holeIndex, distance) {
            if (holeIndex >= holeDistanceConstraints.length) {
                return '';
            }
            
            const constraint = holeDistanceConstraints[holeIndex];
            const dist = Math.abs(distance);
            
            if (dist >= constraint.comfortable.min && dist <= constraint.comfortable.max) {
                return '‚úì';
            } else if (dist >= constraint.difficult.min && dist <= constraint.difficult.max) {
                return '‚ö† Difficult';
            } else if (dist > constraint.limit) {
                return `‚ö† Exceeds ${constraint.limit}mm`;
            } else {
                return '‚ö† Too close';
            }
        }

        function selectInterval(holeIndex, totalHoles) {
            const selectElement = document.getElementById(`interval-select-${holeIndex}`);
            const selectedIdx = parseInt(selectElement.value);
            const interval = intervalRatios[selectedIdx];
            
            const currentFreq = holeFrequencies[holeIndex];
            const nextFreq = currentFreq * interval.ratio;
            
            holeFrequencies.push(nextFreq);
            selectedIntervals.push(interval);
            
            // Recalculate table with selected intervals
            updateTableWithCustomIntervals();
            
            // Build next hole selector or finish
            if (holeIndex + 1 < totalHoles) {
                buildHoleSelector(holeIndex + 1, totalHoles);
            } else {
                buildHoleSelector(totalHoles, totalHoles); // Show completion message
            }
        }

        function updateTableWithCustomIntervals() {
            const diameter = parseFloat(document.getElementById('simple-diameter').value);
            const temp = parseFloat(document.getElementById('simple-temp').value);
            const speedOfSound = (331.3 + 0.606 * temp) * 1000; // mm/s
            const endCorrection = 0.6 * diameter;
            
            const tbody = document.getElementById('simple-tbody');
            tbody.innerHTML = '';
            
            // Calculate all positions first
            const positions = [];
            for (let i = 0; i < selectedIntervals.length; i++) {
                const frequency = holeFrequencies[i + 1];
                const effectiveLength = (speedOfSound / (2 * frequency)) - endCorrection;
                positions.push(effectiveLength);
            }
            
            // Build table rows with distance calculations
            for (let i = 0; i < selectedIntervals.length; i++) {
                const frequency = holeFrequencies[i + 1];
                const interval = selectedIntervals[i];
                const position = positions[i].toFixed(2);
                const note = getNoteName(frequency);
                
                // Calculate distance to next hole (center to center)
                let distanceCell = '';
                if (i < selectedIntervals.length - 1) {
                    const distance = Math.abs(positions[i] - positions[i + 1]);
                    distanceCell = distance.toFixed(2);
                } else {
                    distanceCell = '‚Äî';
                }
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${i + 1}</td>
                    <td>${position}</td>
                    <td>${distanceCell}</td>
                    <td>${interval.name} (${interval.ratio.toFixed(3)})</td>
                    <td>${note}</td>
                    <td>${frequency.toFixed(2)}</td>
                `;
                tbody.appendChild(row);
            }
            
            document.getElementById('simple-results').classList.remove('hidden');
        }

        function getNoteName(frequency) {
            // A4 = 440 Hz
            const A4 = 440;
            const C0 = A4 * Math.pow(2, -4.75); // C0 frequency
            
            const halfSteps = 12 * Math.log2(frequency / C0);
            const noteIndex = Math.round(halfSteps) % 12;
            const octave = Math.floor(Math.round(halfSteps) / 12);
            
            const noteNames = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
            return `${noteNames[noteIndex]}${octave}`;
        }

        // Acoustical Physics Method
        function calculateAcoustical() {
            const baseFreq = parseFloat(document.getElementById('acoustical-frequency').value);
            const diameter = parseFloat(document.getElementById('acoustical-diameter').value);
            const temp = parseFloat(document.getElementById('acoustical-temp').value);
            const numHoles = parseInt(document.getElementById('acoustical-holes').value);
            
            // Speed of sound in air (temperature dependent)
            const speedOfSound = (331.3 + 0.606 * temp) * 1000; // mm/s
            
            // End correction
            const endCorrection = 0.6 * diameter;
            
            const tbody = document.getElementById('acoustical-tbody');
            tbody.innerHTML = '';
            
            // Calculate for chromatic scale
            const semitones = [2, 4, 5, 7, 9, 11, 12, 14];
            
            for (let i = 0; i < numHoles; i++) {
                const semitone = semitones[i];
                const frequency = (baseFreq * Math.pow(2, semitone / 12)).toFixed(2);
                const effectiveLength = (speedOfSound / (2 * frequency)) - endCorrection;
                const position = effectiveLength.toFixed(2);
                const note = getNoteFromSemitones(2, semitone);
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${i + 1}</td>
                    <td>${position}</td>
                    <td>${note}</td>
                    <td>${frequency}</td>
                `;
                tbody.appendChild(row);
            }
            
            document.getElementById('acoustical-results').classList.remove('hidden');
        }

        // Benade's Formula
        function calculateBenade() {
            const length = parseFloat(document.getElementById('benade-length').value);
            const boreDiameter = parseFloat(document.getElementById('benade-bore').value);
            const holeDiameter = parseFloat(document.getElementById('benade-hole-dia').value);
            const wallThickness = parseFloat(document.getElementById('benade-wall').value);
            const numHoles = parseInt(document.getElementById('benade-holes').value);
            
            const tbody = document.getElementById('benade-tbody');
            tbody.innerHTML = '';
            
            // Correction factor based on hole-to-bore ratio
            const K = 0.25; // Empirical constant
            const holeRatio = holeDiameter / boreDiameter;
            const correctionFactor = 1 + K * Math.pow(holeRatio, 2);
            
            // Wall thickness correction (chimney effect)
            const chimneyCorrection = 0.75 * wallThickness;
            
            const semitones = [2, 4, 5, 7, 9, 11, 12, 14];
            
            for (let i = 0; i < numHoles; i++) {
                const semitone = semitones[i];
                const ratio = 1 - Math.pow(2, -semitone / 12);
                const basicPosition = length * ratio;
                
                // Apply Benade's corrections
                const correctedPosition = (basicPosition * correctionFactor + chimneyCorrection).toFixed(2);
                const note = getNoteFromSemitones(2, semitone);
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${i + 1}</td>
                    <td>${basicPosition.toFixed(2)}</td>
                    <td>${correctedPosition}</td>
                    <td>${note}</td>
                `;
                tbody.appendChild(row);
            }
            
            document.getElementById('benade-results').classList.remove('hidden');
        }

        // Global variable to store current flute data for visualization
        let currentFluteData = null;

        // Show visualization modal
        function showVisualization() {
            if (!currentFluteData) {
                alert('Veuillez d\'abord calculer les positions des trous.');
                return;
            }
            
            // Generate SVG
            const svg = generateFluteSVG(currentFluteData);
            document.getElementById('flute-drawing-container').innerHTML = svg;
            
            // Show modal
            document.getElementById('visualization-modal').classList.add('active');
        }

        // Close visualization modal
        function closeVisualization() {
            document.getElementById('visualization-modal').classList.remove('active');
        }

        // Close if clicking on backdrop
        function closeVisualizationIfBackdrop(event) {
            if (event.target.id === 'visualization-modal') {
                closeVisualization();
            }
        }

        // Generate SVG drawing of the flute
        function generateFluteSVG(fluteData) {
            const { positions, numHoles, diameter } = fluteData;
            
            // Calculate SVG dimensions
            const maxPosition = Math.max(...positions);
            const fluteLength = maxPosition + 50; // Add some margin
            
            // SVG scaling factor (pixels per mm)
            const scale = 1.5;
            const svgHeight = fluteLength * scale;
            const svgWidth = 300;
            
            // Flute tube dimensions
            const tubeWidth = diameter * scale;
            const tubeX = (svgWidth - tubeWidth) / 2;
            
            // Default hole diameter (8mm)
            const holeRadius = 4 * scale;
            
            let svg = `
                <svg class="flute-svg" viewBox="0 0 ${svgWidth} ${svgHeight}" xmlns="http://www.w3.org/2000/svg">
                    <!-- Background -->
                    <rect width="${svgWidth}" height="${svgHeight}" fill="#f5e6d3"/>
                    
                    <!-- Flute tube -->
                    <rect x="${tubeX}" y="0" width="${tubeWidth}" height="${svgHeight}" 
                          fill="#d4b896" stroke="#8b6f47" stroke-width="2" rx="5"/>
                    
                    <!-- Wood grain effect -->
                    <rect x="${tubeX}" y="0" width="${tubeWidth}" height="${svgHeight}" 
                          fill="url(#woodGrain)" opacity="0.3" rx="5"/>
                    
                    <!-- Blowing edge (embouchure) -->
                    <ellipse cx="${svgWidth / 2}" cy="20" rx="${tubeWidth / 2 + 5}" ry="10" 
                             fill="#6d5738" stroke="#5d4a37" stroke-width="2"/>
                    <text x="${svgWidth / 2}" y="50" text-anchor="middle" font-size="12" fill="#3e2723" font-weight="bold">
                        Embouchure
                    </text>
            `;
            
            // Draw holes
            for (let i = 0; i < numHoles; i++) {
                const position = positions[i] * scale;
                let holeX = svgWidth / 2;
                
                // Special positioning rules:
                // For 8 holes: hole 1 is left/right (pinky), hole 8 is back
                // For 7 holes: hole 7 is back
                let isBackHole = false;
                let isPinkyHole = false;
                
                if (numHoles === 8) {
                    if (i === 0) {
                        // Hole 1 - pinky hole (offset to right)
                        holeX = svgWidth / 2 + tubeWidth / 2 - 5;
                        isPinkyHole = true;
                    } else if (i === 7) {
                        // Hole 8 - back hole
                        holeX = svgWidth / 2 - tubeWidth / 2 - 5;
                        isBackHole = true;
                    }
                } else if (numHoles === 7 && i === 6) {
                    // Hole 7 - back hole
                    holeX = svgWidth / 2 - tubeWidth / 2 - 5;
                    isBackHole = true;
                }
                
                // Draw hole
                svg += `
                    <circle cx="${holeX}" cy="${position}" r="${holeRadius}" 
                            fill="${isBackHole ? '#4a5d4a' : '#3e2723'}" 
                            stroke="${isBackHole || isPinkyHole ? '#ff6b6b' : '#2d1f1a'}" 
                            stroke-width="2"/>
                `;
                
                // Label
                let label = `Trou ${i + 1}`;
                if (isBackHole) label += ' (dos)';
                if (isPinkyHole) label += ' (auriculaire)';
                
                const labelX = holeX + holeRadius + 15;
                svg += `
                    <text x="${labelX}" y="${position + 4}" font-size="11" fill="#3e2723">
                        ${label}
                    </text>
                    <text x="${labelX}" y="${position + 16}" font-size="9" fill="#6d5738" font-style="italic">
                        ${positions[i].toFixed(1)} mm
                    </text>
                `;
                
                // Draw distance lines between holes
                if (i < numHoles - 1) {
                    const nextPosition = positions[i + 1] * scale;
                    const midY = (position + nextPosition) / 2;
                    const lineX = tubeX - 20;
                    const distance = Math.abs(positions[i] - positions[i + 1]);
                    
                    svg += `
                        <line x1="${lineX}" y1="${position}" x2="${lineX}" y2="${nextPosition}" 
                              stroke="#8b6f47" stroke-width="1" stroke-dasharray="2,2"/>
                        <line x1="${lineX - 3}" y1="${position}" x2="${lineX + 3}" y2="${position}" 
                              stroke="#8b6f47" stroke-width="1"/>
                        <line x1="${lineX - 3}" y1="${nextPosition}" x2="${lineX + 3}" y2="${nextPosition}" 
                              stroke="#8b6f47" stroke-width="1"/>
                        <text x="${lineX - 5}" y="${midY}" font-size="9" fill="#6d5738" text-anchor="end">
                            ${distance.toFixed(1)}mm
                        </text>
                    `;
                }
            }
            
            // Add wood grain pattern definition
            svg = `
                <svg class="flute-svg" viewBox="0 0 ${svgWidth} ${svgHeight}" xmlns="http://www.w3.org/2000/svg">
                    <defs>
                        <pattern id="woodGrain" patternUnits="userSpaceOnUse" width="20" height="100">
                            <path d="M0,0 Q10,50 0,100" stroke="#8b6f47" stroke-width="0.5" fill="none" opacity="0.3"/>
                            <path d="M10,0 Q20,50 10,100" stroke="#8b6f47" stroke-width="0.5" fill="none" opacity="0.3"/>
                        </pattern>
                    </defs>
                    ${svg.substring(svg.indexOf('<!-- Background -->'))}
                </svg>
            `;
            
            return svg;
        }
    </script>
</body>
</html>
